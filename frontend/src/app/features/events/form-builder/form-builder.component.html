<app-header></app-header>

<main class="form-builder-container">
    <!-- Page header -->
    <div class="page-header">
        <h1 class="event-title">{{ eventName() }}</h1>
    </div>

    <!-- Loading state -->
    @if (loading()) {
        <div class="loading-container">
            <mat-spinner diameter="48"></mat-spinner>
            <span>Laddar formulär...</span>
        </div>
    }

    <!-- Main content -->
    @if (!loading()) {
        <div class="builder-layout" [class.preview-active]="previewMode()">

            <!-- Left Panel: Field Library -->
            @if (!previewMode()) {
                <aside class="field-library">
                    <h2 class="panel-title">Fält</h2>

                    <!-- Tabs -->
                    <div class="library-tabs">
                        <button
                                class="tab-btn"
                                [class.active]="activeTab() === 'predefined'"
                                (click)="activeTab.set('predefined')">
                            Predefined
                        </button>
                        <button
                                class="tab-btn"
                                [class.active]="activeTab() === 'standard'"
                                (click)="activeTab.set('standard')">
                            Standard
                        </button>
                    </div>

                    <!-- Predefined fields -->
                    @if (activeTab() === 'predefined') {
                        <div
                                cdkDropList
                                id="predefined-list"
                                [cdkDropListData]="predefinedFields"
                                [cdkDropListConnectedTo]="rowIds()"
                                [cdkDropListSortingDisabled]="true"
                                class="field-list">
                            @for (field of predefinedFields; track field.type) {
                                <div
                                        cdkDrag
                                        [cdkDragData]="field"
                                        class="field-item"
                                        [class.has-settings]="hasSettings(field)">
                                    <mat-icon class="field-icon">{{ field.icon }}</mat-icon>
                                    <span class="field-label">{{ field.label }}</span>
                                    @if (hasSettings(field)) {
                                        <button
                                                mat-icon-button
                                                class="settings-btn"
                                                (click)="openFieldSettings(field, $event)"
                                                matTooltip="Hantera alternativ">
                                            <mat-icon>settings</mat-icon>
                                        </button>
                                    }

                                    <div *cdkDragPreview class="drag-preview">
                                        <mat-icon>{{ field.icon }}</mat-icon>
                                        {{ field.label }}
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    <!-- Standard fields -->
                    @if (activeTab() === 'standard') {
                        <div
                                cdkDropList
                                id="standard-list"
                                [cdkDropListData]="baseFields"
                                [cdkDropListConnectedTo]="rowIds()"
                                [cdkDropListSortingDisabled]="true"
                                class="field-list">
                            @for (field of baseFields; track field.type) {
                                <div
                                        cdkDrag
                                        [cdkDragData]="field"
                                        class="field-item">
                                    <mat-icon class="field-icon">{{ field.icon }}</mat-icon>
                                    <span class="field-label">{{ field.label }}</span>

                                    <div *cdkDragPreview class="drag-preview">
                                        <mat-icon>{{ field.icon }}</mat-icon>
                                        {{ field.label }}
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </aside>
            }

            <!-- Center: Form Canvas -->
            <section class="form-canvas">
                <!-- Canvas header -->
                <div class="canvas-header">
                    <div class="toggle-group">
                        <button
                                class="toggle-btn"
                                [class.active]="!previewMode()"
                                (click)="previewMode.set(false)">
                            Edit
                        </button>
                        <button
                                class="toggle-btn"
                                [class.active]="previewMode()"
                                (click)="previewMode.set(true)">
                            Preview
                        </button>
                    </div>

                    @if (!previewMode()) {
                        <button class="add-row-btn" (click)="addRow()">
                            <mat-icon>add</mat-icon>
                            Add Row
                        </button>
                    }
                </div>

                <!-- Canvas content -->
                <div class="canvas-content" [class.preview-mode]="previewMode()">
                    @if (previewMode()) {
                        <!-- PREVIEW MODE - clean web form look -->
                        <div class="preview-form-container">
                            <div class="preview-form">
                                @for (row of rows(); track trackByRowId($index, row)) {
                                    @if (row.fields.length > 0) {
                                        <div class="preview-row">
                                            @for (field of row.fields; track trackByFieldId($index, field)) {
                                                <div class="preview-field-wrapper" [style.flex]="'1 1 ' + (field.colWidth || 100) + '%'" [style.max-width.%]="field.colWidth || 100">
                                                    <mat-form-field appearance="outline" class="preview-form-field">
                                                        <mat-label>{{ field.label }}{{ field.required ? ' *' : '' }}</mat-label>
                                                        @switch (field.fieldType) {
                                                            @case ('TEXTAREA') {
                                                                <textarea matInput [placeholder]="field.placeholder || ''" rows="3"></textarea>
                                                            }
                                                            @case ('SELECT') {
                                                                <mat-select [placeholder]="field.placeholder || 'Välj...'">
                                                                    @for (opt of field.options; track opt.value) {
                                                                        <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
                                                                    }
                                                                </mat-select>
                                                            }
                                                            @case ('CHECKBOX') {
                                                                <input matInput style="display:none">
                                                            }
                                                            @default {
                                                                <input matInput [placeholder]="field.placeholder || ''">
                                                            }
                                                        }
                                                    </mat-form-field>
                                                </div>
                                            }
                                        </div>
                                    }
                                }

                                <div class="preview-form-actions">
                                    <button class="preview-cancel-btn">Avbryt</button>
                                    <button class="preview-submit-btn">Skicka anmälan</button>
                                </div>
                            </div>
                        </div>
                    } @else {
                        <!-- EDIT MODE -->
                        <div
                                cdkDropList
                                [cdkDropListData]="rows()"
                                (cdkDropListDropped)="onDropRow($event)"
                                class="rows-container">
                            @for (row of rows(); track trackByRowId($index, row); let i = $index) {
                                <div
                                        class="form-row"
                                        [class.empty-row]="row.fields.length === 0"
                                        cdkDrag>

                                    <!-- Row drag handle -->
                                    <div class="row-drag-handle" cdkDragHandle>
                                        <mat-icon>drag_indicator</mat-icon>
                                    </div>

                                    <!-- Row content area -->
                                    <div class="row-content">
                                        <!-- Row header -->
                                        <div class="row-header">
                                            <span class="row-label">Rad</span>
                                            <button
                                                    mat-icon-button
                                                    class="delete-row-btn"
                                                    (click)="removeRow(row.id)"
                                                    matTooltip="Ta bort rad">
                                                <mat-icon>close</mat-icon>
                                            </button>
                                        </div>

                                        <!-- Fields drop zone -->
                                        <div
                                                cdkDropList
                                                [id]="'row-' + row.id"
                                                [cdkDropListData]="row.fields"
                                                [cdkDropListConnectedTo]="['predefined-list', 'standard-list'].concat(rowIds())"
                                                (cdkDropListDropped)="onDropField($event, row.id)"
                                                class="row-fields">

                                            @if (row.fields.length === 0) {
                                                <div class="row-placeholder">
                                                    <mat-icon>add_circle_outline</mat-icon>
                                                    <span>Dra ett fält hit</span>
                                                </div>
                                            }

                                            @for (field of row.fields; track trackByFieldId($index, field)) {
                                                <div
                                                        class="field-card"
                                                        [class.selected]="selectedField()?.tempId === field.tempId || selectedField()?.id === field.id"
                                                        [style.flex]="'1 1 ' + (field.colWidth || 100) + '%'"
                                                        [style.max-width.%]="field.colWidth || 100"
                                                        cdkDrag
                                                        (click)="selectField(field, row.id)">

                                                    <div class="field-card-header">
                                                        <mat-icon cdkDragHandle class="field-drag">drag_indicator</mat-icon>
                                                        <mat-icon class="field-type-icon">{{ getFieldIcon(field) }}</mat-icon>
                                                        <button
                                                                mat-icon-button
                                                                class="delete-field-btn"
                                                                (click)="deleteField(field, row.id); $event.stopPropagation()"
                                                                matTooltip="Ta bort fält">
                                                            <mat-icon>delete</mat-icon>
                                                        </button>
                                                    </div>
                                                    <div class="field-card-content">
                                                        <mat-form-field appearance="outline" class="edit-field-input">
                                                            <mat-label>{{ field.label }}{{ field.required ? ' *' : '' }}</mat-label>
                                                            <input matInput [placeholder]="field.placeholder || ''" disabled>
                                                        </mat-form-field>
                                                    </div>

                                                    <div *cdkDragPlaceholder class="field-placeholder"></div>
                                                </div>
                                            }
                                        </div>
                                    </div>

                                    <div *cdkDragPlaceholder class="row-drag-placeholder"></div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </section>

            <!-- Right Panel: Field Properties -->
            @if (!previewMode()) {
                <aside class="field-properties">
                    <h2 class="panel-title">Egenskaper</h2>

                    @if (!selectedField()) {
                        <div class="no-selection">
                            <mat-icon>touch_app</mat-icon>
                            <p>Välj ett fält för att redigera dess egenskaper</p>
                        </div>
                    }

                    @if (selectedField(); as field) {
                        <div class="properties-form">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Label</mat-label>
                                <input
                                        matInput
                                        [ngModel]="field.label"
                                        (ngModelChange)="onLabelChange($event)">
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Placeholder</mat-label>
                                <input
                                        matInput
                                        [ngModel]="field.placeholder"
                                        (ngModelChange)="onPlaceholderChange($event)">
                            </mat-form-field>

                            <mat-checkbox
                                    [ngModel]="field.required"
                                    (ngModelChange)="onRequiredChange($event)"
                                    color="primary">
                                Obligatoriskt
                            </mat-checkbox>
                        </div>
                    }
                </aside>
            }
        </div>

        <!-- Bottom action bar -->
        <div class="action-bar">
            <div class="action-bar-content">
                @if (hasChanges()) {
                    <span class="unsaved-indicator">
                        <mat-icon>warning</mat-icon>
                        Osparade ändringar
                    </span>
                }
                <div class="action-buttons">
                    <button class="close-btn" (click)="goBack()">
                        <mat-icon>close</mat-icon>
                        Stäng
                    </button>
                    <button
                            class="save-btn"
                            (click)="saveForm()"
                            [disabled]="saving()">
                        @if (saving()) {
                            <mat-spinner diameter="20"></mat-spinner>
                        } @else {
                            <mat-icon>save</mat-icon>
                        }
                        <span>Spara formulär</span>
                    </button>
                </div>
            </div>
        </div>
    }
</main>